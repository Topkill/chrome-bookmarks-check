<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Worker æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .status-box {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-label {
            font-weight: bold;
            color: #666;
        }
        .status-value {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        .active {
            background: #4CAF50;
            color: white;
        }
        .inactive {
            background: #f44336;
            color: white;
        }
        .warning {
            background: #ff9800;
            color: white;
        }
        .log-box {
            background: #2b2b2b;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #4CAF50;
            padding-left: 10px;
        }
        .log-entry.error {
            border-left-color: #f44336;
            color: #ff6b6b;
        }
        .log-entry.warning {
            border-left-color: #ff9800;
            color: #ffd93d;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .test-section {
            margin-top: 20px;
        }
        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
        }
        .instructions h3 {
            color: #1976D2;
            margin-top: 0;
        }
        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .instructions li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ›¡ï¸ ä¹¦ç­¾å“¨å…µ Service Worker æµ‹è¯•é¡µé¢</h1>

    <div class="instructions">
        <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
        <ol>
            <li>é¦–å…ˆï¼Œç¡®ä¿å·²ç»å®‰è£…å¹¶å¯ç”¨äº†ä¹¦ç­¾å“¨å…µæ‰©å±•</li>
            <li>é‡æ–°åŠ è½½æ‰©å±•ï¼ˆåœ¨æ‰©å±•ç®¡ç†é¡µé¢ç‚¹å‡»åˆ·æ–°æŒ‰é’®ï¼‰</li>
            <li>æ‰“å¼€æ­¤æµ‹è¯•é¡µé¢ï¼Œè§‚å¯ŸService WorkerçŠ¶æ€</li>
            <li>ç­‰å¾…30ç§’ä»¥ä¸Šï¼Œçœ‹Service Workeræ˜¯å¦ä»ç„¶ä¿æŒæ´»è·ƒ</li>
            <li>ç‚¹å‡»æµ‹è¯•æŒ‰é’®éªŒè¯åŠŸèƒ½æ˜¯å¦æ­£å¸¸</li>
        </ol>
    </div>

    <div class="status-box">
        <h2>ğŸ“Š Service Worker çŠ¶æ€ç›‘æ§</h2>
        <div class="status-item">
            <span class="status-label">æ‰©å±•ID:</span>
            <span class="status-value" id="extensionId">æ£€æµ‹ä¸­...</span>
        </div>
        <div class="status-item">
            <span class="status-label">Service WorkerçŠ¶æ€:</span>
            <span class="status-value" id="swStatus">æ£€æµ‹ä¸­...</span>
        </div>
        <div class="status-item">
            <span class="status-label">æœ€åæ´»è·ƒæ—¶é—´:</span>
            <span class="status-value" id="lastActive">--:--:--</span>
        </div>
        <div class="status-item">
            <span class="status-label">æŒç»­è¿è¡Œæ—¶é—´:</span>
            <span class="status-value" id="uptime">0ç§’</span>
        </div>
        <div class="status-item">
            <span class="status-label">Keep-AliveçŠ¶æ€:</span>
            <span class="status-value" id="keepAliveStatus">æ£€æµ‹ä¸­...</span>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª åŠŸèƒ½æµ‹è¯•</h2>
        <button onclick="testMessage()">å‘é€æµ‹è¯•æ¶ˆæ¯</button>
        <button onclick="testCacheStatus()">è·å–ç¼“å­˜çŠ¶æ€</button>
        <button onclick="testBookmarkQuery()">æµ‹è¯•ä¹¦ç­¾æŸ¥è¯¢</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="log-box" id="logBox">
        <div class="log-entry">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
    </div>

    <script>
        // ä¹¦ç­¾å“¨å…µæ‰©å±•IDï¼ˆéœ€è¦æ ¹æ®å®é™…å®‰è£…åçš„IDæ›´æ–°ï¼‰
        const EXTENSION_ID = 'YOUR_EXTENSION_ID_HERE';
        let startTime = Date.now();
        let swCheckInterval;
        let lastKeepAliveTime = 0;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            entry.textContent = `[${timestamp}] ${message}`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('logBox').innerHTML = '<div class="log-entry">æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        // æ£€æµ‹æ‰©å±•æ˜¯å¦å®‰è£…
        async function detectExtension() {
            try {
                // å°è¯•é€šè¿‡æŸ¥æ‰¾æ‰©å±•ç®¡ç†é¡µé¢æ¥æ£€æµ‹
                const extensions = await chrome.management.getAll();
                const bookmarkSentry = extensions.find(ext => 
                    ext.name.includes('ä¹¦ç­¾å“¨å…µ') || ext.name.includes('Bookmark Sentry')
                );
                
                if (bookmarkSentry) {
                    document.getElementById('extensionId').textContent = bookmarkSentry.id;
                    document.getElementById('extensionId').className = 'status-value active';
                    log(`æ£€æµ‹åˆ°ä¹¦ç­¾å“¨å…µæ‰©å±•: ${bookmarkSentry.id}`);
                    return bookmarkSentry.id;
                }
            } catch (e) {
                // å¦‚æœæ²¡æœ‰managementæƒé™ï¼Œå°è¯•ç›´æ¥å‘é€æ¶ˆæ¯
                log('ä½¿ç”¨å¤‡ç”¨æ–¹æ³•æ£€æµ‹æ‰©å±•...', 'warning');
            }
            
            document.getElementById('extensionId').textContent = 'æœªæ£€æµ‹åˆ°';
            document.getElementById('extensionId').className = 'status-value inactive';
            return null;
        }

        // æ£€æŸ¥Service WorkerçŠ¶æ€
        async function checkServiceWorkerStatus() {
            try {
                // æ£€æŸ¥localStorageä¸­çš„keep-aliveæ—¶é—´æˆ³
                const response = await chrome.runtime.sendMessage(EXTENSION_ID || '', {
                    type: 'GET_CACHE_STATUS'
                });
                
                if (response) {
                    document.getElementById('swStatus').textContent = 'æ´»è·ƒ';
                    document.getElementById('swStatus').className = 'status-value active';
                    document.getElementById('lastActive').textContent = new Date().toLocaleTimeString('zh-CN');
                    
                    // æ›´æ–°è¿è¡Œæ—¶é—´
                    const uptime = Math.floor((Date.now() - startTime) / 1000);
                    document.getElementById('uptime').textContent = `${uptime}ç§’`;
                    
                    log('Service Workerå“åº”æ­£å¸¸');
                    return true;
                }
            } catch (error) {
                document.getElementById('swStatus').textContent = 'æ— å“åº”';
                document.getElementById('swStatus').className = 'status-value inactive';
                log(`Service Workeræ— å“åº”: ${error.message}`, 'error');
                return false;
            }
        }

        // æ£€æŸ¥Keep-Aliveæœºåˆ¶
        async function checkKeepAlive() {
            try {
                // ä»Chrome storageè¯»å–keep-aliveæ—¶é—´æˆ³
                chrome.storage.local.get(['_keepAlive'], (result) => {
                    if (result._keepAlive) {
                        const timeDiff = Date.now() - result._keepAlive;
                        if (timeDiff < 35000) { // 35ç§’å†…æœ‰æ›´æ–°
                            document.getElementById('keepAliveStatus').textContent = 'æ­£å¸¸å·¥ä½œ';
                            document.getElementById('keepAliveStatus').className = 'status-value active';
                            lastKeepAliveTime = result._keepAlive;
                        } else {
                            document.getElementById('keepAliveStatus').textContent = `${Math.floor(timeDiff/1000)}ç§’æœªæ›´æ–°`;
                            document.getElementById('keepAliveStatus').className = 'status-value warning';
                        }
                    }
                });
            } catch (error) {
                log(`Keep-Aliveæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•æ¶ˆæ¯å‘é€
        async function testMessage() {
            log('å‘é€æµ‹è¯•æ¶ˆæ¯...');
            try {
                const response = await chrome.runtime.sendMessage(EXTENSION_ID || '', {
                    type: 'GET_CACHE_STATUS'
                });
                if (response) {
                    log(`æ”¶åˆ°å“åº”: ${JSON.stringify(response)}`);
                } else {
                    log('æœªæ”¶åˆ°å“åº”', 'error');
                }
            } catch (error) {
                log(`å‘é€æ¶ˆæ¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•ç¼“å­˜çŠ¶æ€
        async function testCacheStatus() {
            log('è·å–ç¼“å­˜çŠ¶æ€...');
            try {
                const response = await chrome.runtime.sendMessage(EXTENSION_ID || '', {
                    type: 'GET_CACHE_STATUS'
                });
                if (response) {
                    log(`ç¼“å­˜çŠ¶æ€: æ€»æ•°=${response.totalBookmarks}, å·²ç¼“å­˜=${response.cachedUrls}`);
                }
            } catch (error) {
                log(`è·å–ç¼“å­˜çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•ä¹¦ç­¾æŸ¥è¯¢
        async function testBookmarkQuery() {
            log('æµ‹è¯•ä¹¦ç­¾æŸ¥è¯¢...');
            const testUrls = ['https://www.google.com', 'https://www.github.com'];
            try {
                const response = await chrome.runtime.sendMessage(EXTENSION_ID || '', {
                    type: 'QUERY_URLS',
                    payload: { urls: testUrls }
                });
                if (response && response.bookmarkedUrls) {
                    log(`æŸ¥è¯¢ç»“æœ: ${JSON.stringify(response.bookmarkedUrls)}`);
                }
            } catch (error) {
                log(`ä¹¦ç­¾æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆå§‹åŒ–
        async function init() {
            log('åˆå§‹åŒ–æµ‹è¯•é¡µé¢...');
            
            // æ£€æµ‹æ‰©å±•
            const extId = await detectExtension();
            
            // å¼€å§‹å®šæœŸæ£€æŸ¥
            swCheckInterval = setInterval(async () => {
                await checkServiceWorkerStatus();
                await checkKeepAlive();
            }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
            
            // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
            await checkServiceWorkerStatus();
            await checkKeepAlive();
            
            log('æµ‹è¯•é¡µé¢å·²å‡†å¤‡å°±ç»ª');
            log('ğŸ’¡ æç¤º: ç­‰å¾…30ç§’ä»¥ä¸Šè§‚å¯ŸService Workeræ˜¯å¦ä¿æŒæ´»è·ƒ', 'warning');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (swCheckInterval) {
                clearInterval(swCheckInterval);
            }
        });
    </script>
</body>
</html>